<!doctype html>
<html lang="zh-CN">
<head>
<link rel="apple-touch-icon" href="iconsage180.png">
<meta name="apple-mobile-web-app-title" content="å½“ä½ è€äº†">

<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>å½“ä½ è€äº†</title>
<style>
  :root{
    --text:#fff; --muted:rgba(255,255,255,.88);
    --glass:rgba(0,0,0,.12); --panel:rgba(0,0,0,.28);
    --shadow:0 12px 28px rgba(0,0,0,.45); --radius:16px;
    --dim:.10;
    --fz-base:clamp(14px,1.6vw,18px); --fz-h1:clamp(22px,2.4vw,34px); --fz-num:clamp(36px,6vw,72px);
  }
  html,body{margin:0;padding:0;background:#0b0f16;color:var(--text);
    font:var(--fz-base)/1.55 -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif}
  /* èƒŒæ™¯ï¼šçœŸå® IMG + è½»é®ç½©ï¼ˆæ›´ç¨³ï¼‰ */
  #bg{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;object-position:center 35%;z-index:0}
  .veil{position:fixed;inset:0;background:rgba(0,0,0,var(--dim));z-index:1;pointer-events:none}
  .glow{position:fixed;inset:-25vh -25vw;filter:blur(70px) opacity(.75);z-index:2;pointer-events:none;
    background:
      radial-gradient(40% 40% at 20% 20%, rgba(255,154,162,.20), transparent 60%),
      radial-gradient(45% 45% at 85% 25%, rgba(156,217,255,.20), transparent 60%),
      radial-gradient(50% 50% at 18% 80%, rgba(168,230,207,.18), transparent 60%),
      radial-gradient(55% 55% at 75% 85%, rgba(199,206,255,.18), transparent 60%);}
  .wrap{position:relative;z-index:3;max-width:960px;margin:0 auto;padding:28px 22px 88px}
  h1{margin:0 0 10px;font-size:var(--fz-h1);letter-spacing:.3px;text-shadow:0 2px 10px rgba(0,0,0,.35)}
  .sub{color:var(--muted);margin:6px 0 10px;text-shadow:0 2px 8px rgba(0,0,0,.30)}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 16px}
  .pill{position:relative;padding:8px 12px;border-radius:999px;background:var(--panel);
        backdrop-filter:blur(6px);box-shadow:var(--shadow);font-weight:700;cursor:pointer}
  .pill.sel{background:linear-gradient(135deg,rgba(155,209,255,.95),rgba(235,207,255,.95));color:#111}
  .pill::before,.card::before,.fab::before{
    content:"";position:absolute;inset:0;border-radius:inherit;padding:1.2px;
    background:conic-gradient(from 180deg,#ff9aa2,#ffdac1,#e2f0cb,#a8e6cf,#9cd9ff,#c7ceff,#ff9aa2);
    -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
    -webkit-mask-composite:xor;mask-composite:exclude;opacity:.75;pointer-events:none}
  .panel{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px}
  .card{position:relative;background:var(--glass);backdrop-filter:blur(2px);border-radius:var(--radius);
        padding:16px;text-align:center;box-shadow:var(--shadow)}
  .num{font-variant-numeric:tabular-nums;letter-spacing:.5px;font-size:var(--fz-num);font-weight:900;margin-bottom:6px;text-shadow:0 1px 6px rgba(0,0,0,.25)}
  .label{opacity:.95}
  .summary{margin-top:14px;font-variant-numeric:tabular-nums;text-shadow:0 2px 8px rgba(0,0,0,.28)}
  .fab-wrap{position:fixed;right:14px;bottom:14px;display:flex;flex-direction:column;gap:10px;z-index:4}
  .fab{position:relative;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,.28);
       backdrop-filter:blur(6px);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;font-size:18px;opacity:.9}
  #file{display:none}
  .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);z-index:5;
    background:rgba(0,0,0,.6);color:#fff;padding:8px 12px;border-radius:999px;font-size:13px;
    backdrop-filter:blur(6px);opacity:0;transition:opacity .25s}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <img id="bg" alt="">
  <div class="veil"></div>
  <div class="glow"></div>

  <div class="wrap">
    <h1>å½“ä½ è€äº†</h1>
    <div id="nowline" class="sub"></div>
    <div class="toolbar">
      <div class="pill sel" data-mode="year">æŒ‰å¹´</div>
      <div class="pill" data-mode="month">æŒ‰æœˆ</div>
      <div class="pill" data-mode="day">æŒ‰å¤©</div>
    </div>
    <div id="panel" class="panel"></div>
    <div id="summary" class="summary"></div>
    <div id="birthline" class="sub"></div>
  </div>

  <div class="fab-wrap">
    <div class="fab" id="btnImport" title="å¯¼å…¥èƒŒæ™¯">ğŸ–¼ï¸</div>
    <div class="fab" id="btnClear"  title="æ¸…é™¤èƒŒæ™¯">âŒ«</div>
  </div>
  <input id="file" type="file" accept="image/*">
  <div id="toast" class="toast">èƒŒæ™¯å·²è®¾ç½® âœ“</div>

<script>
/* ===== å…±äº«èƒŒæ™¯å­˜å‚¨ï¼šIndexedDB ä¼˜å…ˆ + localStorage å…œåº• ===== */
const BG_KEY='shared_bg_v1';          // ä¸¤é¡µå…±ç”¨
const DB_NAME='his_site_store';
const bg = document.getElementById('bg');
const toast = document.getElementById('toast');
function tip(s){toast.textContent=s;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1200);}

function openDB(){ return new Promise((ok,err)=>{ const r=indexedDB.open(DB_NAME,1); r.onupgradeneeded=()=>r.result.createObjectStore('kv'); r.onsuccess=()=>ok(r.result); r.onerror=()=>err(r.error); }); }
async function idbGet(k){ try{const db=await openDB();return await new Promise((res,rej)=>{const t=db.transaction('kv','readonly');const g=t.objectStore('kv').get(k);g.onsuccess=()=>{res(g.result);db.close();};g.onerror=()=>{rej(g.error);db.close();};});}catch(e){return null;} }
async function idbSet(k,blob){ const db=await openDB(); await new Promise((res,rej)=>{const t=db.transaction('kv','readwrite');const p=t.objectStore('kv').put(blob,k);p.onsuccess=()=>{res();db.close();};p.onerror=()=>{rej(p.error);db.close();};}); }
async function idbDel(k){ try{const db=await openDB();await new Promise((res,rej)=>{const t=db.transaction('kv','readwrite');const d=t.objectStore('kv').delete(k);d.onsuccess=()=>{res();db.close();};d.onerror=()=>{rej(d.error);db.close();};});}catch(e){} }

(async ()=>{ // åˆå§‹åŒ–ï¼šIDB->LS
  try{
    const blob=await idbGet(BG_KEY);
    if(blob && blob.size){ bg.src=URL.createObjectURL(blob); return; }
  }catch(e){}
  const ls=localStorage.getItem(BG_KEY);
  if(ls) bg.src = ls;
})();

document.getElementById('btnImport').addEventListener('click',()=>file.click());
const file=document.getElementById('file');

file.addEventListener('change', async ()=>{
  const f=file.files&&file.files[0]; if(!f) return;
  // é¢„è§ˆç«‹åˆ»å¯è§ï¼šç›´æ¥ç”¨å¯¹è±¡URLï¼ˆå³ä½¿æ˜¯ HEIC ä¹Ÿèƒ½æ˜¾ç¤ºï¼‰
  const objURL=URL.createObjectURL(f); bg.src=objURL;

  // å°è¯•è½¬æˆ JPEG å­˜å‚¨ï¼ˆå¤±è´¥åˆ™ç›´æ¥å­˜åŸå§‹ Blobï¼‰
  try{
    const bmp = await createImageBitmap(f).catch(()=>null);
    let blobToSave = f;
    if(bmp){
      const c=document.createElement('canvas'); c.width=bmp.width; c.height=bmp.height;
      c.getContext('2d').drawImage(bmp,0,0);
      blobToSave = await new Promise(r=>c.toBlob(r,'image/jpeg',0.85));
    }
    await idbSet(BG_KEY, blobToSave);
    try{ // å¤‡ä»½ä¸€ä»½ dataURL åˆ° localStorageï¼ˆå¯èƒ½è¾ƒå¤§ï¼Œå°½é‡å¿½ç•¥å¤±è´¥ï¼‰
      const fr=new FileReader(); fr.onload=()=>{try{localStorage.setItem(BG_KEY, fr.result);}catch(e){}};
      fr.readAsDataURL(blobToSave);
    }catch(e){}
    tip('èƒŒæ™¯å·²ä¿å­˜ âœ“');
  }catch(e){
    try{ localStorage.setItem(BG_KEY, objURL); tip('å·²è®¾ç½®ï¼Œä½†æœªæŒä¹…ä¿å­˜'); }catch(_){ tip('è®¾ç½®å¤±è´¥'); }
  }
  file.value="";
});

document.getElementById('btnClear').addEventListener('click', async ()=>{
  bg.removeAttribute('src');
  await idbDel(BG_KEY); try{localStorage.removeItem(BG_KEY);}catch(e){}
  tip('å·²æ¸…é™¤èƒŒæ™¯');
});

/* ===== å¹´é¾„ï¼šæŒ‰å¹´/æŒ‰æœˆ/æŒ‰å¤© ===== */
const TZ='Asia/Shanghai';
const BIRTH='1997-07-01T05:37:00';
function pad(n){return String(n).padStart(2,'0')}
function isLeap(y){return (y%4===0 && (y%100!==0 || y%400===0))}
function dim(y,m){return [31,isLeap(y)?29:28,31,30,31,30,31,31,30,31,30,31][m-1]}
function parseDT(s){const r=String(s).match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?$/);return {Y:+r[1],M:+r[2],D:+r[3],h:+r[4],min:+r[5],s:+(r[6]||0)}}
const B=parseDT(BIRTH);
function nowParts(zone){
  const f=new Intl.DateTimeFormat('en-CA',{timeZone:zone,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false});
  const ps=f.formatToParts(new Date()); const m={}; for(const p of ps) if(p.type!=='literal') m[p.type]=+p.value;
  return {Y:m.year,M:m.month,D:m.day,h:m.hour,min:m.minute,s:m.second};
}
function diffYMDHMS(n,b){
  let Y=n.Y-b.Y,M=n.M-b.M,D=n.D-b.D,h=n.h-b.h,m=n.min-b.min,s=n.s-b.s;
  if(s<0){s+=60;m--;} if(m<0){m+=60;h--;} if(h<0){h+=24;D--;}
  if(D<0){let pm=n.M-1,py=n.Y;if(pm===0){pm=12;py--;} D+=dim(py,pm); M--;}
  if(M<0){M+=12;Y--;} return {Y,M,D,h,m,s};
}
function sumMonthDaysFrom(y,m,c){let t=0;for(let i=0;i<c;i++){t+=dim(y,m);m++;if(m===13){m=1;y++;}}return t}

let mode='year';
function addCard(p,num,label){const c=document.createElement('div');c.className='card';c.innerHTML=`<div class="num">${num}</div><div class="label">${label}</div>`;p.appendChild(c);}
function render(){
  const n=nowParts(TZ); const d=diffYMDHMS(n,B);
  const months=d.Y*12+d.M; const days=sumMonthDaysFrom(B.Y,B.M,months)+d.D;
  document.getElementById('nowline').textContent=`å½“å‰ï¼ˆ${TZ}ï¼‰ï¼š${n.Y}-${pad(n.M)}-${pad(n.D)} ${pad(n.h)}:${pad(n.min)}:${pad(n.s)}`;
  document.getElementById('birthline').textContent=`çˆ±åœ¨é»æ˜ç ´æ™“å‰ï¼š ${B.Y}-${pad(B.M)}-${pad(B.D)} ${pad(B.h)}:${pad(B.min)}:${pad(B.s)} Â· æ—¶åŒºï¼š${TZ}`;
  const panel=document.getElementById('panel'); panel.innerHTML='';
  if(mode==='year'){ addCard(panel,d.Y,'å¹´');addCard(panel,d.M,'æœˆ');addCard(panel,d.D,'å¤©');addCard(panel,d.h,'å°æ—¶');addCard(panel,d.m,'åˆ†é’Ÿ');addCard(panel,d.s,'ç§’');
    document.getElementById('summary').textContent=`å·²æ»¡ ${d.Y} å¹´ ${d.M} ä¸ªæœˆ ${d.D} å¤© ${d.h} å°æ—¶ ${d.m} åˆ† ${d.s} ç§’`;
  }else if(mode==='month'){ addCard(panel,months,'æœˆ');addCard(panel,d.D,'å¤©');addCard(panel,d.h,'å°æ—¶');addCard(panel,d.m,'åˆ†é’Ÿ');addCard(panel,d.s,'ç§’');
    document.getElementById('summary').textContent=`å·²æ»¡ ${months} ä¸ªæœˆ ${d.D} å¤© ${d.h} å°æ—¶ ${d.m} åˆ† ${d.s} ç§’`;
  }else{ addCard(panel,days,'å¤©');addCard(panel,d.h,'å°æ—¶');addCard(panel,d.m,'åˆ†é’Ÿ');addCard(panel,d.s,'ç§’');
    document.getElementById('summary').textContent=`å·²æ»¡ ${days} å¤© ${d.h} å°æ—¶ ${d.m} åˆ† ${d.s} ç§’`; }
}
document.querySelectorAll('.pill[data-mode]').forEach(el=>{
  el.addEventListener('click',()=>{document.querySelectorAll('.pill[data-mode]').forEach(p=>p.classList.remove('sel'));el.classList.add('sel');mode=el.getAttribute('data-mode');render();});
});
render(); setInterval(render,1000);
</script>
</body>
</html>

